version: "3.9"

x-logging-config: &logging-config
  logging:
    driver: gcplogs
    options:
      gcp-project: ${GCLOUD_PROJECT_ID}

services:

  web:
    <<: *logging-config
    build:
      context: ./web
    ports:
      - 8002:8002
    volumes:
      - ./web:/web
      - node-modules:/web/node_modules
    env_file:
      - ./.env
    depends_on:
      - api

  api:
    <<: *logging-config
    build:
      context: ./api
    ports:
      - 8000:8000
    volumes:
      - ./api:/api
    env_file:
      - ./.env
    environment:
      - DEBUG=1
      - SYNTHESIS_URL=http://api_synthesis:8001
    depends_on:
      - api_synthesis

  api_synthesis:
    <<: *logging-config
    build:
      context: ./api-synthesis
    ports:
      - 8001:8001
    volumes:
      - ./api-synthesis:/api-synthesis
    env_file:
      - ./.env
    environment:
      - DEBUG=1

  proxy:
    <<: *logging-config
    build:
      context: ./proxy
    restart: always
    ports:
      - 80:9000
    depends_on:
      - api

volumes:
  node-modules: